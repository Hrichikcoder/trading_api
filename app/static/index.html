<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantBoard - Professional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: #334155; --accent: #6366f1;
        }
        [data-theme="light"] {
            --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --accent: #4f46e5;
        }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; transition: 0.3s; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border); }
        .card-header { border-bottom: 1px solid var(--border); font-weight: 600; }
        .form-control, .form-select { background-color: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); }
        
        /* --- VISIBILITY FIX --- */
        .table { color: var(--text-main); --bs-table-color: var(--text-main); }
        .table thead th { background-color: var(--bg-card); color: var(--text-muted); border-bottom: 2px solid var(--border); }
        .table tbody td { border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        /* Modal Fix for Dark Mode */
        .modal-content { background-color: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); }
        .modal-header { border-bottom: 1px solid var(--border); }
        .modal-footer { border-top: 1px solid var(--border); }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

        .metric-val { font-size: 2rem; font-weight: 800; }
        .text-success-c { color: #10b981 !important; }
        .text-danger-c { color: #ef4444 !important; }
        #loader { position: fixed; inset: 0; background: rgba(15,23,42,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary mb-3"></div>
    <div class="text-white">Fetching Data...</div>
</div>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0"><i class="bi bi-graph-up-arrow text-primary"></i> QuantBoard</h3>
            <small class="text-muted">Data Source: <span class="badge bg-secondary">Local DB (5 Years)</span></small>
        </div>
        <button onclick="toggleTheme()" class="btn btn-outline-secondary btn-sm"><i class="bi bi-moon-stars"></i> Theme</button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">NET RETURN (5Y)</small><div id="net-return" class="metric-val">--</div></div></div>
        <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">WIN RATE</small><div id="win-rate" class="metric-val">--</div></div></div>
        <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">TOTAL TRADES</small><div id="total-trades" class="metric-val">--</div></div></div>
        <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">AVG PNL</small><div id="avg-pnl" class="metric-val">--</div></div></div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Trade History (Last 5)</span>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#historyModal">
                        View All History
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead><tr><th>Entry</th><th>Exit</th><th>In ($)</th><th>Out ($)</th><th class="text-end">PnL %</th></tr></thead>
                        <tbody id="trades-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">Advanced Signal Check</div>
                <div class="card-body">
                    <label class="small text-muted mb-1">Asset</label>
                    <input id="sym-in" type="text" class="form-control mb-3" value="ETH-USD">
                    
                    <div class="row g-2 mb-3">
                        <div class="col-7">
                            <label class="small text-muted mb-1">Indicator</label>
                            <select id="ind-sel" class="form-select" onchange="updatePlaceholder()">
                                <option value="sma">SMA</option>
                                <option value="ema">EMA</option>
                                <option value="rsi">RSI</option>
                                <option value="bb">Bollinger Bands</option>
                                <option value="macd">MACD</option>
                            </select>
                        </div>
                        <div class="col-5">
                            <label class="small text-muted mb-1">Params</label>
                            <input id="ind-param" type="text" class="form-control" value="20" placeholder="e.g. 50">
                        </div>
                    </div>
                    
                    <button onclick="checkSignal()" class="btn btn-primary w-100 mb-3">Analyze Signal</button>
                    
                    <div id="res-box" class="p-3 border rounded text-center" style="background: var(--bg-body);">
                        <small class="text-muted">Select indicator and params</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Full Trade History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead><tr><th>Entry</th><th>Exit</th><th>In ($)</th><th>Out ($)</th><th class="text-end">PnL %</th></tr></thead>
                    <tbody id="modal-table-body"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let isDark = true;
    function toggleTheme() {
        isDark = !isDark;
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }

    function updatePlaceholder() {
        const type = document.getElementById('ind-sel').value;
        const input = document.getElementById('ind-param');
        if(type === 'macd') input.value = "12_26_9";
        else if(type === 'bb') input.value = "20_2";
        else input.value = "20";
    }

    async function loadData() {
        try {
            const res = await fetch('/stats/strategy/backtest?symbol=BTC-USD');
            const data = await res.json();
            
            document.getElementById('net-return').innerText = (data.net_return || 0) + "%";
            document.getElementById('total-trades').innerText = data.total_count || 0;
            
            const trades = data.recent_trades || [];
            const allTrades = data.all_trades || [];
            
            const wins = allTrades.filter(t => t.pnl_percent > 0).length;
            const winRate = allTrades.length > 0 ? ((wins/allTrades.length)*100).toFixed(1) : 0;
            
            document.getElementById('win-rate').innerText = winRate + "%";
            document.getElementById('avg-pnl').innerText = (data.total_count > 0) ? (data.net_return / data.total_count).toFixed(2) + "%" : "0%";

            // 1. Populate Dashboard Table (Last 5)
            const tbody = document.getElementById('trades-table');
            tbody.innerHTML = '';
            [...trades].reverse().forEach(t => {
                const color = t.pnl_percent >= 0 ? 'text-success-c' : 'text-danger-c';
                tbody.innerHTML += `<tr>
                    <td>${t.entry_date}</td><td>${t.exit_date}</td>
                    <td>$${t.entry_price.toLocaleString()}</td><td>$${t.exit_price.toLocaleString()}</td>
                    <td class="text-end fw-bold ${color}">${t.pnl_percent}%</td>
                </tr>`;
            });

            // 2. Populate Modal Table (All Trades)
            const modalBody = document.getElementById('modal-table-body');
            modalBody.innerHTML = '';
            [...allTrades].reverse().forEach(t => {
                const color = t.pnl_percent >= 0 ? 'text-success-c' : 'text-danger-c';
                modalBody.innerHTML += `<tr>
                    <td>${t.entry_date}</td><td>${t.exit_date}</td>
                    <td>$${t.entry_price.toLocaleString()}</td><td>$${t.exit_price.toLocaleString()}</td>
                    <td class="text-end fw-bold ${color}">${t.pnl_percent}%</td>
                </tr>`;
            });

            document.getElementById('loader').classList.add('hidden');
        } catch(e) { document.getElementById('loader').classList.add('hidden'); }
    }

    async function checkSignal() {
        const sym = document.getElementById('sym-in').value;
        const type = document.getElementById('ind-sel').value;
        const param = document.getElementById('ind-param').value;
        const indString = `${type}_${param}`;

        const box = document.getElementById('res-box');
        box.innerHTML = "Calculating...";
        
        try {
            const res = await fetch(`/stats/${sym}/${indString}`);
            const d = await res.json();
            let color = 'bg-secondary';
            if(d.signal.includes('BUY') || d.signal == 'BULLISH') color = 'bg-success';
            if(d.signal.includes('SELL') || d.signal == 'BEARISH' || d.signal == 'OVERBOUGHT') color = 'bg-danger';
            
            let details = d.details ? `<div class="small text-muted mt-1">${d.details}</div>` : '';

            box.innerHTML = `
                <h6 class="text-uppercase text-muted">${d.indicator}</h6>
                <h2 class="fw-bold">${d.value.toFixed(2)}</h2>
                <span class="badge ${color} px-3 py-2">${d.signal}</span>
                ${details}
            `;
        } catch(e) { box.innerHTML = "Error fetching data"; }
    }

    loadData();
</script>
</body>
</html>