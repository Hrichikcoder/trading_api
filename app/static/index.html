<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantBoard - Algo Trading Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --bg-body: #111827;       
            --bg-card: #1f2937;       
            --bg-nav: #1f2937;
            --text-main: #ffffff;     
            --text-muted: #9ca3af;    
            --border-color: #374151;
            --accent: #818cf8;        
            --input-bg: #111827;
        }

        body.light-mode {
            --bg-body: #f3f4f6;       
            --bg-card: #ffffff;       
            --bg-nav: #ffffff;
            --text-main: #1f2937;     
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --accent: #4f46e5;        
            --input-bg: #ffffff;
        }

        /* --- 2. SCREEN STYLES --- */
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
        }

        /* Elements hidden on screen, visible in PDF */
        .print-only { display: none !important; }

        .navbar { 
            background-color: var(--bg-nav) !important; 
            border-bottom: 1px solid var(--border-color);
        }
        
        .card { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header { 
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-main);
            font-weight: 600; 
        }

        .metric-value { font-size: 2.2rem; font-weight: 800; color: var(--text-main); }
        .metric-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        .table { --bs-table-color: var(--text-main); --bs-table-bg: transparent; }
        .table thead th { border-bottom: 2px solid var(--border-color); color: var(--text-muted); }
        .table td { border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .table-hover tbody tr:hover { background-color: rgba(128, 128, 128, 0.1); }

        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }
        
        .btn-primary { background-color: var(--accent); border-color: var(--accent); }
        .text-success-custom { color: #10b981 !important; }
        .text-danger-custom { color: #ef4444 !important; }
        .spinner-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }

        /* --- 3. PROFESSIONAL PDF STYLES --- */
        @media print {
            /* Hide UI Elements */
            .navbar, .btn, .no-print, #loader, .form-control, .form-select { display: none !important; }
            
            /* Show Report Headers */
            .print-only { display: block !important; }

            /* Reset Page Colors */
            body { 
                background-color: white !important; 
                color: black !important; 
                font-family: 'Times New Roman', serif; /* Professional Serif Font for Report */
                font-size: 12pt;
                margin: 0;
                padding: 0;
            }

            /* Container Layout */
            .container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            
            /* Professional Header */
            .report-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }
            .report-title { font-size: 24pt; font-weight: bold; text-transform: uppercase; }
            .report-meta { font-size: 10pt; color: #555; margin-top: 5px; }

            /* Metrics Grid for Print */
            .row.g-3 { display: flex; justify-content: space-between; margin-bottom: 20px; }
            .col-md-3 { width: 23%; float: left; }
            .card { 
                border: 1px solid #000 !important; 
                box-shadow: none !important; 
                background: white !important; 
                color: black !important;
                border-radius: 0 !important;
            }
            .metric-value { font-size: 1.5rem !important; color: black !important; }
            .metric-label { color: #333 !important; }

            /* Table Styling */
            .card-body { max-height: none !important; overflow: visible !important; }
            .col-lg-8 { width: 100% !important; flex: 0 0 100%; max-width: 100%; }
            .col-lg-4 { display: none !important; } /* Hide Live Checker in Print */
            
            .table { width: 100%; border-collapse: collapse; }
            .table th { 
                background-color: #f0f0f0 !important; 
                color: black !important; 
                font-weight: bold; 
                border: 1px solid #000 !important;
                padding: 8px;
            }
            .table td { 
                border: 1px solid #ccc !important; 
                color: black !important; 
                padding: 6px;
            }
            .text-success-custom { color: #000 !important; font-weight: normal; } /* Remove green for print readability */
            .text-danger-custom { color: #000 !important; font-weight: normal; }

            /* Footer */
            .print-footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                font-size: 9pt;
                border-top: 1px solid #ccc;
                padding-top: 5px;
            }
        }
    </style>
</head>
<body>

<div id="loader" class="spinner-overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
</div>

<div class="print-only report-header">
    <div class="report-title">Algorithmic Trading Performance Report</div>
    <div class="report-meta">
        Generated by QuantBoard • Strategy: EMA Crossover • Asset: BTC-USD • Date: <span id="print-date"></span>
    </div>
</div>

<nav class="navbar navbar-expand-lg mb-4 sticky-top">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <i class="bi bi-graph-up-arrow text-primary me-2"></i>
            <span class="fw-bold" style="color: var(--text-main);">QuantBoard</span>
        </a>
        <div class="d-flex gap-2 align-items-center">
            <button onclick="toggleTheme()" class="btn btn-outline-secondary btn-sm" title="Toggle Theme">
                <i id="theme-icon" class="bi bi-sun-fill"></i>
            </button>
            <button onclick="window.print()" class="btn btn-primary btn-sm">
                <i class="bi bi-printer"></i> Print Report
            </button>
            <a href="/docs" target="_blank" class="btn btn-outline-secondary btn-sm" style="border-color: var(--accent); color: var(--accent);">
                API Docs
            </a>
        </div>
    </div>
</nav>

<div class="container" id="dashboard-content">
    
    <div class="row mb-4 align-items-end no-print">
        <div class="col-md-8">
            <h2 class="fw-bold mb-1">Strategy Performance</h2>
            <p class="text-muted mb-0">BTC-USD | EMA Crossover (12/26) | Daily</p>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge bg-secondary" id="current-date"></span>
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card p-4 text-center h-100">
                <div class="metric-label">Net Return</div>
                <div id="net-return" class="metric-value">--%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-4 text-center h-100">
                <div class="metric-label">Win Rate</div>
                <div id="win-rate" class="metric-value">--%</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-4 text-center h-100">
                <div class="metric-label">Total Trades</div>
                <div id="total-trades" class="metric-value">--</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-4 text-center h-100">
                <div class="metric-label">Avg PnL</div>
                <div id="avg-pnl" class="metric-value">--%</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center no-print">
                    <span>Trade History</span>
                    <span class="badge bg-primary rounded-pill" id="trade-count-badge">0</span>
                </div>
                <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead class="sticky-top" style="background-color: var(--bg-card); z-index: 2;">
                            <tr>
                                <th>Entry Date</th>
                                <th>Exit Date</th>
                                <th>Entry ($)</th>
                                <th>Exit ($)</th>
                                <th class="text-end">PnL %</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4 no-print">
            <div class="card h-100">
                <div class="card-header">Live Signal Check</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Asset</label>
                        <input type="text" id="symbol-input" class="form-control" value="ETH-USD">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Indicator</label>
                        <select class="form-select" id="indicator-select">
                            <option value="rsi">RSI</option>
                            <option value="sma">SMA</option>
                            <option value="ema">EMA</option>
                            <option value="bb">Bollinger Bands</option>
                            <option value="atr">ATR</option>
                            <option value="obv">OBV</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100 mb-4" onclick="fetchIndicator()">Check</button>
                    <div id="indicator-result" class="p-4 rounded border text-center">
                        <small class="text-muted">Result...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="print-only print-footer">
    CONFIDENTIAL - Generated by Automated Trading System
</div>

<script>
    // Theme Logic
    function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('theme-icon');
        body.classList.toggle('light-mode');
        if (body.classList.contains('light-mode')) {
            icon.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
            localStorage.setItem('theme', 'light');
        } else {
            icon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
            localStorage.setItem('theme', 'dark');
        }
    }
    if (localStorage.getItem('theme') === 'light') toggleTheme();

    // Data Logic
    const today = new Date().toLocaleDateString();
    document.getElementById('current-date').innerText = today;
    document.getElementById('print-date').innerText = today;

    async function loadBacktest() {
        try {
            const response = await fetch('/stats/strategy/backtest?symbol=BTC-USD');
            const data = await response.json();
            
            // Metrics
            const netReturnEl = document.getElementById('net-return');
            netReturnEl.innerText = data.net_return_percent + "%";
            netReturnEl.className = `metric-value ${data.net_return_percent >= 0 ? 'text-success-custom' : 'text-danger-custom'}`;
            
            document.getElementById('total-trades').innerText = data.total_trades;
            document.getElementById('trade-count-badge').innerText = data.total_trades;

            const wins = data.trades.filter(t => t.pnl_percent > 0).length;
            const winRate = data.total_trades > 0 ? ((wins / data.total_trades) * 100).toFixed(1) : 0;
            document.getElementById('win-rate').innerText = winRate + "%";

            const avgPnl = (data.net_return_percent / data.total_trades).toFixed(2);
            const avgEl = document.getElementById('avg-pnl');
            avgEl.innerText = avgPnl + "%";
            avgEl.className = `metric-value ${avgPnl >= 0 ? 'text-success-custom' : 'text-danger-custom'}`;
            
            // Table
            const tbody = document.getElementById('trades-table');
            tbody.innerHTML = '';
            [...data.trades].reverse().forEach(t => {
                const pnlClass = t.pnl_percent >= 0 ? 'text-success-custom' : 'text-danger-custom';
                const row = `<tr>
                    <td>${t.entry_date}</td>
                    <td>${t.exit_date}</td>
                    <td>$${t.entry_price.toLocaleString()}</td>
                    <td>$${t.exit_price.toLocaleString()}</td>
                    <td class="text-end ${pnlClass} fw-bold">${t.pnl_percent}%</td>
                </tr>`;
                tbody.innerHTML += row;
            });
            document.getElementById('loader').classList.add('hidden');
        } catch (e) { 
            document.getElementById('loader').innerHTML = '<div class="text-danger">API Error</div>';
        }
    }

    async function fetchIndicator() {
        const sym = document.getElementById('symbol-input').value;
        const ind = document.getElementById('indicator-select').value;
        const resultDiv = document.getElementById('indicator-result');
        
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div>';
        try {
            const res = await fetch(`/stats/${sym}/${ind}`);
            if(!res.ok) throw new Error("Error");
            const data = await res.json();
            const lastVal = data.values[data.values.length - 1];
            const lastSig = data.buy_sell_signals[data.buy_sell_signals.length - 1];
            
            let color = 'var(--accent)';
            if(lastSig === 'BUY') color = '#10b981';
            if(lastSig === 'SELL') color = '#ef4444';

            resultDiv.innerHTML = `
                <h5 class="text-muted text-uppercase small mb-2">${ind} Value</h5>
                <h2 class="fw-bold mb-3" style="color: var(--text-main)">${lastVal}</h2>
                <span class="badge px-4 py-2 fs-6" style="background-color: ${color}; color: white;">${lastSig}</span>
            `;
        } catch (e) {
            resultDiv.innerHTML = `<div class="text-danger small">Error fetching data</div>`;
        }
    }
    loadBacktest();
</script>

</body>
</html>